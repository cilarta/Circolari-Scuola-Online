<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Supporto Docenti</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        /* Sezione Login */
        #login-section, #admin-login-section { text-align: center; margin-bottom: 20px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        input[type="text"], input[type="password"] { padding: 10px; width: 70%; margin-bottom: 10px; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .admin-btn { background-color: #6c757d; margin-top: 10px; font-size: 0.8em; }

        /* Checklist Supporto Docenti */
        .circolare { 
            border-bottom: 1px solid #eee; 
            padding: 15px; 
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
            transition: all 0.3s ease; /* Animazione fluida */
        }

        /* STILE PER CIRCOLARI GI√Ä LETTE (MODIFICATO: Molto pi√π piccolo) */
        .circolare-letta {
            opacity: 0.5;              /* Molto trasparente */
            font-size: 0.7em;          /* Carattere molto piccolo */
            background-color: #f9f9f9; /* Sfondo quasi bianco */
            border: 1px solid #eee;
            padding: 8px;              /* Meno spazio interno */
        }
        
        /* Quando √® letta, nascondiamo anche un po' di margine del testo interno */
        .circolare-letta .circolare-content {
            margin-bottom: 2px;
        }

        .circolare-content { font-size: 1.1em; margin-bottom: 10px; display: block; margin-top: 5px; }
        
        /* Correzione per il testo interno quando rimpicciolito */
        .circolare-letta .circolare-content { font-size: 1em; } 

        .meta-info { font-size: 0.8em; color: #888; margin-bottom: 5px; }
        
        /* Checkbox */
        .check-container { display: flex; align-items: center; cursor: pointer; margin-top: 10px;}
        .check-container input { margin-right: 10px; transform: scale(1.5); }
        
        /* Scaliamo la checkbox se la circolare √® letta per non farla sembrare gigante */
        .circolare-letta .check-container input { transform: scale(1.0); }

        .read-confirm { color: green; font-weight: bold; display: none; margin-left: 10px;}
        input:checked ~ .read-confirm { display: inline; }

        /* Admin Panel & Editor */
        #admin-panel { border: 2px solid #dc3545; padding: 15px; margin-bottom: 20px; background-color: #fff8f8; display: none; }
        #admin-panel h3 { color: #dc3545; margin-top: 0; }
        
        /* Editor Visuale Stile */
        .toolbar { background: #eee; padding: 5px; border: 1px solid #ccc; border-bottom: none; display: flex; gap: 5px; flex-wrap: wrap; }
        .toolbar button { padding: 5px 10px; background: white; border: 1px solid #999; color: black; font-weight: bold; cursor: pointer; }
        .toolbar button:hover { background: #ddd; }
        #editor { 
            width: 100%; 
            min-height: 100px; 
            padding: 10px; 
            border: 1px solid #ccc; 
            background: white; 
            margin-bottom: 10px; 
            box-sizing: border-box; 
            overflow-y: auto;
        }

        .reader-list { font-size: 0.8em; color: #555; background: #eee; padding: 10px; margin-top: 5px; border-radius: 4px; }
        
        /* Bottone Elimina */
        .delete-btn {
            background-color: #dc3545; 
            font-size: 0.8em; 
            padding: 5px 10px; 
            margin-left: 10px;
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè´ Checklist Supporto Docenti</h1>

    <div id="login-section">
        <h3>Chi sei?</h3>
        <input type="text" id="usernameInput" placeholder="Inserisci il tuo Nome e Cognome (es. Mario Rossi)">
        <br>
        <button onclick="login()">Entra</button>
        <br>
        <button class="admin-btn" onclick="showAdminLogin()">Area Amministratore</button>
    </div>

    <div id="admin-login-section" class="hidden">
        <h3>Accesso Amministratore</h3>
        <input type="password" id="adminPasswordInput" placeholder="Password Admin">
        <br>
        <button onclick="adminLogin()">Sblocca</button>
        <button class="admin-btn" onclick="hideAdminLogin()">Torna indietro</button>
    </div>

    <div id="main-interface" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <p>Ciao, <b id="currentUserDisplay"></b></p>
            <button onclick="logout()" style="background:#dc3545; padding: 5px 10px;">Esci</button>
        </div>
        <hr>

        <div id="admin-panel">
            <h3>üõ† Scrivi Nuova Circolare</h3>
            
            <div class="toolbar">
                <button onclick="formatDoc('bold')" title="Grassetto">B</button>
                <button onclick="formatDoc('italic')" title="Corsivo">I</button>
                <button onclick="formatDoc('underline')" title="Sottolineato">U</button>
                
                <button onclick="formatDoc('foreColor', 'black')" style="color:black; border-color:black;" title="Nero (Predefinito)">A</button>
                <button onclick="formatDoc('foreColor', 'red')" style="color:red" title="Rosso">A</button>
                <button onclick="formatDoc('foreColor', 'blue')" style="color:blue" title="Blu">A</button>
                <button onclick="formatDoc('foreColor', 'green')" style="color:green" title="Verde">A</button>
                
                <button onclick="formatDoc('removeFormat')" title="Pulisci Stile">üßΩ</button>
            </div>
            
            <div id="editor" contenteditable="true" placeholder="Scrivi qui..."></div>
            
            <button onclick="addCircolare()" style="margin-top:10px; width:100%;">Pubblica Circolare</button>
        </div>

        <div id="lista-circolari">
            <p>Caricamento circolari in corso...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- TUA CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDSJItcfmcwhmnmZ8YxmgBVdpCzPfKmHTQ",
        authDomain: "circolari-online-docenti.firebaseapp.com",
        databaseURL: "https://circolari-online-docenti-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "circolari-online-docenti",
        storageBucket: "circolari-online-docenti.firebasestorage.app",
        messagingSenderId: "692753452418",
        appId: "1:692753452418:web:15a59bf3edef2c7e26d39b"
    };

    // Inizializza Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Variabili Globali
    let currentUser = localStorage.getItem('school_user') || "";
    let isAdmin = false;
    const ADMIN_PASS = "scuola2024"; 

    // --- FUNZIONI EDITOR DI TESTO ---
    window.formatDoc = function(cmd, value) {
        document.execCommand(cmd, false, value);
        document.getElementById('editor').focus();
    };

    // --- FUNZIONI DI LOGIN ---
    window.login = function() {
        const input = document.getElementById('usernameInput').value.trim();
        if(input) {
            currentUser = input.replace(/[.#$/[\]]/g, "_"); 
            localStorage.setItem('school_user', currentUser);
            showInterface();
        } else {
            alert("Inserisci un nome!");
        }
    };

    window.logout = function() {
        localStorage.removeItem('school_user');
        location.reload();
    };

    window.showAdminLogin = function() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-login-section').classList.remove('hidden');
    };

    window.hideAdminLogin = function() {
        document.getElementById('admin-login-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
    };

    window.adminLogin = function() {
        const pass = document.getElementById('adminPasswordInput').value;
        if(pass === ADMIN_PASS) {
            isAdmin = true;
            currentUser = "AMMINISTRATORE"; 
            showInterface();
            document.getElementById('admin-panel').style.display = "block";
        } else {
            alert("Password errata");
        }
    };

    function showInterface() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('admin-login-section').classList.add('hidden');
        document.getElementById('main-interface').classList.remove('hidden');
        document.getElementById('currentUserDisplay').innerText = currentUser;
        
        loadCircolari();
    }

    // --- LOGICA DATABASE ---

    // 1. Aggiungi Circolare
    window.addCircolare = function() {
        const htmlContent = document.getElementById('editor').innerHTML;
        if(htmlContent.trim() === "" || htmlContent === "<br>") {
            alert("Scrivi qualcosa!");
            return;
        }

        const circolariRef = ref(db, 'circolari');
        const newCircolare = {
            testo: htmlContent, 
            data: new Date().toLocaleDateString('it-IT') + " " + new Date().toLocaleTimeString('it-IT'),
            autore: "Presidenza"
        };
        push(circolariRef, newCircolare);
        document.getElementById('editor').innerHTML = ""; 
        alert("Circolare pubblicata!");
    };

    // 2. Elimina Circolare
    window.deleteCircolare = function(id) {
        if(confirm("Sei sicuro di voler ELIMINARE definitivamente questa circolare e tutte le conferme di lettura?")) {
            const circolareRef = ref(db, 'circolari/' + id);
            remove(circolareRef)
                .then(() => alert("Circolare eliminata."))
                .catch((error) => alert("Errore: " + error.message));
        }
    };

    // 3. Carica e Mostra Circolari
    function loadCircolari() {
        const circolariRef = ref(db, 'circolari');
        
        onValue(circolariRef, (snapshot) => {
            const list = document.getElementById('lista-circolari');
            list.innerHTML = ""; 
            const data = snapshot.val();

            if(!data) {
                list.innerHTML = "<p>Nessuna circolare presente.</p>";
                return;
            }

            const entries = Object.entries(data).reverse(); 

            entries.forEach(([id, circolare]) => {
                const div = document.createElement('div');
                div.className = "circolare"; // Classe base

                const hasRead = circolare.letture && circolare.letture[currentUser];
                
                // --- LOGICA RIMICCIOLIMENTO ---
                // Se non sei admin e l'hai letta, aggiungi la classe speciale
                if(!isAdmin && hasRead) {
                    div.classList.add("circolare-letta");
                }

                // Intestazione con Data
                let htmlContent = `<div class="meta-info">Pubblicato il: ${circolare.data}</div>`;

                // Contenuto Circolare
                htmlContent += `<div class="circolare-content">${circolare.testo}</div>`;

                // LOGICA UTENTE: Checkbox
                if(!isAdmin) {
                    htmlContent += `
                        <label class="check-container">
                            <input type="checkbox" 
                                   id="chk_${id}" 
                                   ${hasRead ? "checked disabled" : ""} 
                                   onchange="markAsRead('${id}')">
                            <span>Ho letto</span>
                            <span class="read-confirm"> (Confermato)</span>
                        </label>
                    `;
                }

                // LOGICA ADMIN: Lista lettori + Tasto Elimina
                if(isAdmin) {
                    let readers = "Nessuno ha ancora letto.";
                    let count = 0;
                    if(circolare.letture) {
                        const names = Object.keys(circolare.letture);
                        count = names.length;
                        readers = `<b>Letto da (${count}):</b> ` + names.join(", ");
                    }
                    
                    htmlContent += `
                        <div class="reader-list">
                            ${readers}
                            <br><br>
                            <button class="delete-btn" onclick="deleteCircolare('${id}')">üóë Elimina Circolare</button>
                        </div>
                    `;
                }

                div.innerHTML = htmlContent;
                list.appendChild(div);
            });
        });
    }

    // 4. Segna come letto
    window.markAsRead = function(circolareId) {
        const updates = {};
        updates[`circolari/${circolareId}/letture/${currentUser}`] = true;
        update(ref(db), updates);
    }

    // Auto-login
    if(localStorage.getItem('school_user')) {
        currentUser = localStorage.getItem('school_user');
        showInterface();
    }
</script>

</body>
</html>
